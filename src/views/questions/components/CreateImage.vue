<template>
  <div>
    <el-form :model="form" label-width="80px" ref="form" v-loading="loading">
      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="课程">
            <el-select
              :disabled="courseSelectListDisabled"
              :loading="courseSelectListLoading"
              :remote-method="fetchCourses"
              filterable
              placeholder="请输入关键字自动搜索"
              remote
              reserve-keyword
              v-model="form.course_id"
            >
              <el-option
                :key="course.id"
                :label="course.title"
                :value="course.id"
                v-for="course in courseSelectList"
              ></el-option>
            </el-select>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="题干">
            <el-input v-model="form.title"></el-input>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="题干图片">
            <el-upload
              :action="uploadDomain"
              :before-remove="handleBeforeRemove"
              :before-upload="handleBeforeUpload"
              :data="uploadData"
              :disabled="uploading"
              :file-list="uploadedList"
              :on-preview="handlePreview"
              :on-success="handleQuestionUploadSuccess"
            >
              <el-button :loading="uploading" size="small" type="primary">点击上传</el-button>
            </el-upload>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="类型">
            <el-radio label="single" v-model="form.type">单选</el-radio>
            <el-radio label="multiple" v-model="form.type">多选</el-radio>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="章">
            <el-input v-model="form.chapter"></el-input>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="节">
            <el-input v-model="form.section"></el-input>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="答案">
            <span>{{ form.answer }}</span>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20">
        <el-col :span="12">
          <el-form-item label="解析">
            <el-input v-model="form.explain"></el-input>
          </el-form-item>
        </el-col>
      </el-row>

      <el-row :gutter="20" :key="index" v-for="(option, index) in form.options">
        <el-form-item :label="`选项 ${option.id}`">
          <el-input
            :value="option.id"
            class="hidden"
            type="hidden"
            v-model="form.options[index].id"
          ></el-input>
          <el-col :span="12">
            <el-upload
              :action="uploadDomain"
              :before-remove="handleBeforeRemove"
              :before-upload="handleBeforeUpload"
              :data="uploadData"
              :disabled="uploading"
              :file-list="uploadedList"
              :on-preview="handlePreview"
              :on-success="handleUploadSuccess"
            >
              <el-button
                :loading="uploading"
                @click="handleClick(index)"
                size="small"
                type="primary"
              >点击上传</el-button>
            </el-upload>
          </el-col>
          <el-col :span="6">
            <el-tooltip
              :content="option.right ? '取消正确答案' : '设置正确答案'"
              class="item"
              effect="dark"
              placement="top"
            >
              <el-button
                :icon="option.right ? 'el-icon-check' : 'el-icon-close'"
                :type="option.right ? 'success' : 'danger'"
                @click.prevent="toggleAnswer(option)"
                circle
              ></el-button>
            </el-tooltip>

            <el-button @click.prevent="removeOption(option, index)" type="danger">去除选项</el-button>
          </el-col>
        </el-form-item>
      </el-row>

      <el-form-item>
        <el-button @click.prevent="addOption()" type="success">新增选项</el-button>
        <el-button @click="onSubmit" type="primary">立即创建</el-button>
      </el-form-item>
    </el-form>

    <el-dialog :visible.sync="previewStatus" append-to-body title="预览">
      <img :src="previewUrl" alt="预览图片" width="300">
    </el-dialog>
  </div>
</template>

<script>
import { storeQuestion } from '@/api/questions'
import { getCourses } from '@/api/courses'
import { getToken, deleteImage } from '@/api/cloudStorage'

export default {
  name: 'QuestionImage',
  created() {
    if (this.course) {
      this.courseSelectList.push(this.course)
      this.form.course_id = this.course.id
      this.courseSelectListDisabled = true
    }
  },
  props: ['course'],
  data() {
    return {
      optionType: 'image',
      form: {
        course_id: null,
        title: '',
        image: null,
        type: 'single',
        chapter: null,
        section: null,
        options: [
          { id: 1, content: '', type: 'image', right: false },
          { id: 2, content: '', type: 'image', right: false },
          { id: 3, content: '', type: 'image', right: false },
          { id: 4, content: '', type: 'image', right: false }
        ],
        answer: [],
        explain: ''
      },
      loading: false,
      courseSelectList: [],
      courseSelectListLoading: false,
      courseSelectListDisabled: false,
      uploadDomain: 'http://upload.qiniu.com/',
      uploadData: {
        token: '',
        key: ''
      },
      uploadedList: [],
      uploading: false,
      optionIndex: 0,
      previewStatus: false,
      previewUrl: ''
    }
  },
  methods: {
    fetchCourses(query) {
      this.courseSelectListLoading = true
      getCourses({ title: `%${query}%`, per_page: 100 })
        .then(response => {
          this.courseSelectList = response.data
        })
        .finally(() => {
          this.courseSelectListLoading = false
        })
    },
    onSubmit() {
      this.loading = true
      storeQuestion(this.form)
        .then(response => {
          this.$message.success('添加成功')
          this.$emit('imageCreated', response)
        })
        .finally(() => {
          this.loading = false
        })
    },
    toggleAnswer(option) {
      // 单选
      if (this.form.type === 'single') {
        if (this.form.answer.includes(option.id)) {
          this.form.answer.splice(this.form.answer.indexOf(option.id), 1)
          option.right = false
        } else {
          this.form.answer.length < 1 &&
            this.form.answer.push(option.id) &&
            (option.right = true)
        }
      }
      // 多选
      if (this.form.type === 'multiple') {
        if (this.form.answer.includes(option.id)) {
          this.form.answer.splice(this.form.answer.indexOf(option.id), 1)
          option.right = false
        } else {
          this.form.answer.push(option.id)
          option.right = true
        }
      }
    },
    handleQuestionUploadSuccess(res) {
      this.uploading = false
      this.form.image = res.key
    },
    handleUploadSuccess(res) {
      this.uploading = false
      this.form.options[this.optionIndex].content = res.key
    },
    handleClick(index) {
      this.optionIndex = index
    },
    handleBeforeUpload() {
      this.uploading = true
      return getToken()
        .then(response => {
          this.uploadData.token = response.token
          this.uploadData.key = response.name
        })
        .catch(err => {
          console.log(err)
          return false
        })
    },
    handleBeforeRemove(file, fileList) {
      this.form.options.forEach(item => {
        if (item.content === file.response.key) {
          item.content = null
        }
      })
      deleteImage(file.response.key)
      return true
    },
    handlePreview(file) {
      this.previewUrl = file.url
      this.previewStatus = true
    },
    addOption() {
      let maxId = 0
      if (this.form.options.length === 0) {
        maxId = 0
      } else {
        const maxItem = this.form.options.reduce((prev, current) => {
          return prev.id > current.id ? prev : current
        })
        maxId = maxItem.id
      }
      this.form.options.push({
        id: maxId + 1,
        content: '',
        type: this.optionType,
        right: false
      })
    },
    removeOption(option, index) {
      const answerIndex = this.form.answer.findIndex(item => item === option.id)
      if (answerIndex >= 0) {
        this.form.answer.splice(answerIndex, 1)
      }
      this.form.options.splice(index, 1)
    }
  }
}
</script>

<style rel="stylesheet/scss" lang="scss">
.block {
  width: 100%;
  text-align: center;
}

.search-bar {
  padding: 10px 0 10px 0;
}
</style>
